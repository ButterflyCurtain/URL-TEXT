
<!--
  このHTMLは以下のサードパーティライブラリを使用しています:

  marked - https://marked.js.org/
  Copyright (c) 2018+, MarkedJS (https://github.com/markedjs/)
  MIT License

  DOMPurify - https://github.com/cure53/DOMPurify
  Copyright (c) 2015 Mario Heiderich
  Apache License 2.0 または Mozilla Public License 2.0

  ansi-to-html - https://github.com/rburns/ansi-to-html
  Copyright (c) 2012 Rob Burns
  MIT License
-->

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シンプルテキストツール</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.5/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ansi-to-html@0.7.1/dist/ansi-to-html.min.js"></script>

    <style>
        /* === 基本スタイル === */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #36393f;
            color: #dcddde;
            line-height: 1.6;
        }
        textarea {
            width: 100%;
            box-sizing: border-box;
            height: 250px;
            margin: 10px 0;
            padding: 10px;
            background-color: #40444b;
            color: #dcddde;
            border: 1px solid #202225;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
            font-family: inherit;
        }
        select, input[type="checkbox"], input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            padding: 8px;
            margin: 5px 0;
            background-color: #40444b;
            color: #dcddde;
            border: 1px solid #202225;
            border-radius: 4px;
        }
        button {
            background-color: #5865f2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 2px;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        button:hover {
            background-color: #4752c4;
        }
        #preview {
            background-color: #2f3136;
            padding: 15px 20px;
            border-radius: 4px;
            margin-top: 20px;
            min-height: 150px;
            overflow-x: auto;
            border: 1px solid #202225;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .encoding-toggle {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .url-length {
            margin-top: 10px;
            font-size: 14px;
            color: #8e9297;
        }
        .format-guide {
            background-color: #40444b;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-size: 14px;
            border: 1px solid #2e3035;
        }
        .format-guide code {
            background-color: #2f3136;
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        }
        .title-input {
            margin-bottom: 10px;
        }
        .buttons {
            margin-top: 10px;
        }

        /* === Markdownプレビュースタイル === */

        /* 基本要素のリセット */
        #preview > :first-child { margin-top: 0 !important; }
        #preview > :last-child { margin-bottom: 0 !important; }

        /* 見出し */
        #preview h1, #preview h2, #preview h3, #preview h4, #preview h5, #preview h6 {
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            font-weight: 600;
            line-height: 1.25;
            color: #ffffff;
        }
        #preview h1 { font-size: 2em; border-bottom: 1px solid #4f545c; padding-bottom: 0.3em; }
        #preview h2 { font-size: 1.5em; border-bottom: 1px solid #4f545c; padding-bottom: 0.3em; }
        #preview h3 { font-size: 1.25em; }
        #preview h4 { font-size: 1em; }
        #preview h5 { font-size: 0.875em; }
        #preview h6 { font-size: 0.85em; color: #8e9297; }

        /* 段落 */
        #preview p {
            margin-top: 0;
            margin-bottom: 1em;
        }

        /* 水平線 */
        #preview hr {
            height: 4px;
            padding: 0;
            margin: 24px 0;
            background-color: #4f545c;
            border: 0;
            border-radius: 2px;
        }

        /* 引用 */
        #preview blockquote {
            margin: 0 0 1em 0;
            padding: 0.5em 1em;
            color: #b9bbbe;
            border-left: 4px solid #4f545c;
            background-color: #32353b;
            border-radius: 0 4px 4px 0;
        }
        #preview blockquote > :first-child { margin-top: 0; }
        #preview blockquote > :last-child { margin-bottom: 0; }
        #preview blockquote blockquote {
            margin-left: 1em;
            background-color: #36393f;
        }

        /* リスト */
        #preview ul, #preview ol {
            margin-top: 0;
            margin-bottom: 1em;
            padding-left: 2.5em;
        }
        #preview ul ul, #preview ol ol, #preview ul ol, #preview ol ul {
            margin-top: 0.25em;
            margin-bottom: 0.5em;
        }
        #preview li {
            margin-bottom: 0.4em;
        }
        #preview li > p {
            display: inline;
        }
        #preview ul { list-style-type: disc; }
        #preview ol { list-style-type: decimal; }
        #preview ul ul { list-style-type: circle; }
        #preview ol ol { list-style-type: lower-alpha; }
        #preview ul ul ul { list-style-type: square; }
        #preview ol ol ol { list-style-type: lower-roman; }

        /* コードブロック */
        #preview pre {
            background-color: #202225;
            border: 1px solid #1a1c1f;
            padding: 1em;
            overflow: auto;
            border-radius: 4px;
            margin-bottom: 1em;
            line-height: 1.45;
        }
        #preview pre code {
            background: none;
            padding: 0;
            margin: 0;
            font-size: 0.85em;
            border-radius: 0;
            font-family: Consolas, 'Courier New', Courier, monospace;
            color: #b9bbbe;
            word-break: normal;
            white-space: pre;
            display: block;
        }

        /* インラインコード */
        #preview :not(pre) > code {
            background-color: #202225;
            border: 1px solid #1a1c1f;
            padding: 0.2em 0.4em;
            margin: 0 0.1em;
            font-size: 0.85em;
            border-radius: 3px;
            font-family: Consolas, 'Courier New', Courier, monospace;
            color: #b9bbbe;
            white-space: nowrap;
        }

        /* テーブル */
        #preview table {
            display: block;
            width: max-content;
            max-width: 100%;
            overflow: auto;
            border-collapse: collapse;
            margin-bottom: 1em;
            border: 1px solid #4f545c;
            border-radius: 4px;
            border-spacing: 0;
        }
        #preview th, #preview td {
            padding: 8px 12px;
            border: 1px solid #4f545c;
            text-align: left;
        }
        #preview th {
            font-weight: 600;
            background-color: #2f3136;
            color: #ffffff;
        }
        #preview tr {
            background-color: #36393f;
            border-top: 1px solid #4f545c;
        }
        #preview td {
            color: #dcddde;
        }

        /* リンク */
        #preview a {
            color: #00a8fc;
            text-decoration: none;
        }
        #preview a:hover {
            text-decoration: underline;
        }

        /* 画像 */
        #preview img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 0.5em 0;
            background-color: #2f3136;
            display: block;
        }

        /* 打ち消し線 */
        #preview del {
            color: #8e9297;
            text-decoration: line-through;
        }

        /* スポイラー */
        #preview span.spoiler {
            background-color: #202225;
            color: transparent;
            padding: 0 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out;
            display: inline-block;
            position: relative;
        }
        #preview span.spoiler::before {
            content: attr(data-title);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #dcddde;
            padding: 2px 6px;
            background-color: rgba(32, 34, 37, 0.8);
            border-radius: 3px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        #preview span.spoiler.small-title::before {
            font-size: 12px;
        }
        #preview span.spoiler.large-title::before {
            font-size: 16px;
        }
        #preview span.spoiler.revealed {
            background-color: transparent;
            color: inherit;
        }
        #preview span.spoiler.revealed::before {
            opacity: 0;
        }
        #preview span.spoiler:not(.revealed):hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* タスクリスト */
        #preview .task-list-item {
            list-style-type: none;
            margin-left: -1.5em;
            position: relative;
            padding-left: 1.8em;
            min-height: 1.5em;
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5em;
        }
        #preview .task-list-item input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 1.2em;
            height: 1.2em;
            border: 2px solid #72767d;
            border-radius: 4px;
            background-color: #40444b;
            cursor: default;
            margin-top: 0.15em;
            margin-right: 0.6em;
            flex-shrink: 0;
            position: relative;
            vertical-align: top;
            display: inline-block;
        }
        #preview .task-list-item input[type="checkbox"]:checked {
            background-color: #5865f2;
            border-color: #5865f2;
        }
        #preview .task-list-item input[type="checkbox"]:checked::before {
            content: '';
            display: block;
            width: 0.3em;
            height: 0.6em;
            border: solid #dcddde;
            border-width: 0 0.2em 0.2em 0;
            transform: rotate(45deg) translate(-50%, -60%);
            position: absolute;
            left: 50%;
            top: 50%;
        }
        #preview .task-list-item input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 0.2em rgba(88, 101, 242, 0.5);
        }
        #preview .task-list-item input[type="checkbox"]:checked + span,
        #preview .task-list-item input[type="checkbox"]:checked + label {
            color: #8e9297;
            text-decoration: line-through;
        }
        #preview .task-list-item > span,
        #preview .task-list-item > label {
            margin-top: 0.05em;
            line-height: 1.3;
            color: #dcddde;
        }

        /* --- 追加: 小さく薄い文字 --- */
        #preview .small-muted {
            font-size: 0.85em;
            color: #8e9297;
            opacity: 0.7;
        }
        /* --- 蝶アニメーション --- */
        #preview .interactive-butterfly {
            cursor: pointer;
            transition: filter 0.2s, transform 0.2s;
            filter: drop-shadow(0 0 8px #aaf) brightness(1.18) saturate(1.2);
            display: inline-block;
            /* 発光感を強調 */
            box-shadow: 0 0 12px 4px #aaf8, 0 0 24px 8px #fff4;
        }
        #preview .interactive-butterfly.butterfly-hover {
            filter: drop-shadow(0 0 16px #aaf) brightness(1.3) saturate(1.3);
            transform: scale(1.18) rotate(-10deg);
        }
        #preview .flying-butterfly {
            position: fixed;
            pointer-events: none;
            font-size: 2em;
            z-index: 10000;
            will-change: transform, opacity, left, top;
            transition: opacity 0.3s;
            filter: drop-shadow(0 0 16px #aaf) brightness(1.3) saturate(1.3);
            opacity: 0.92;
        }
        #preview .butterfly-particle-container {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }
        #preview .butterfly-particle {
            position: absolute;
            width: 6px; height: 6px;
            border-radius: 50%;
            background: linear-gradient(135deg, #aaf, #fff, #f8f);
            opacity: 0.7;
            pointer-events: none;
            box-shadow: 0 0 8px 2px #aaf8, 0 0 16px 4px #fff4;
        }

        /* === ここから追加 === */
        /* スクロールバー */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #72767d;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #5865f2;
        }
        ::-webkit-scrollbar-track {
            background-color: #40444b;
            border-radius: 6px;
        }

        /* ボタンスタイル */
        .button-primary {
            background-color: #5865f2;
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease;
        }
        .button-primary:hover {
            background-color: #4752c4;
        }
        .button-secondary {
            background-color: #40444b;
            color: #dcddde;
            border: 1px solid #72767d;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .button-secondary:hover {
            background-color: #35393f;
            border-color: #5865f2;
        }

        /* フォーム要素 */
        input[type="text"], textarea {
            background-color: #40444b;
            color: #dcddde;
            border: 1px solid #202225;
            border-radius: 4px;
            padding: 10px;
            font-size: 16px;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #5865f2;
            box-shadow: 0 0 0 0.2em rgba(88, 101, 242, 0.5);
        }

        /* セレクトボックス */
        select {
            background-color: #40444b;
            color: #dcddde;
            border: 1px solid #202225;
            border-radius: 4px;
            padding: 10px;
            font-size: 16px;
        }
        select:focus {
            outline: none;
            border-color: #5865f2;
            box-shadow: 0 0 0 0.2em rgba(88, 101, 242, 0.5);
        }

        /* リストスタイル */
        ul, ol {
            margin: 0;
            padding-left: 1.5em;
        }
        ul {
            list-style-type: disc;
        }
        ol {
            list-style-type: decimal;
        }
        li {
            margin-bottom: 0.5em;
        }

        /* コードブロック */
        pre {
            background-color: #202225;
            border: 1px solid #1a1c1f;
            padding: 1em;
            overflow: auto;
            border-radius: 4px;
            margin: 1em 0;
            line-height: 1.45;
        }
        pre code {
            background: none;
            padding: 0;
            margin: 0;
            font-size: 0.85em;
            border-radius: 0;
            font-family: Consolas, 'Courier New', Courier, monospace;
            color: #b9bbbe;
            word-break: normal;
            white-space: pre;
            display: block;
        }

        /* インラインコード */
        :not(pre) > code {
            background-color: #202225;
            border: 1px solid #1a1c1f;
            padding: 0.2em 0.4em;
            margin: 0 0.1em;
            font-size: 0.85em;
            border-radius: 3px;
            font-family: Consolas, 'Courier New', Courier, monospace;
            color: #b9bbbe;
            white-space: nowrap;
        }

        /* テーブル */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }
        th, td {
            padding: 0.75em;
            border: 1px solid #4f545c;
            text-align: left;
        }
        th {
            background-color: #2f3136;
            color: #ffffff;
        }
        tr:nth-child(even) {
            background-color: #2c2f33;
        }

        /* リンク */
        a {
            color: #00a8fc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }

        /* 画像 */
        img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            margin: 0.5em 0;
            background-color: #2f3136;
            display: block;
        }

        /* 打ち消し線 */
        del {
            color: #8e9297;
            text-decoration: line-through;
        }

        /* スポイラー */
        span.spoiler {
            background-color: #202225;
            color: transparent;
            padding: 0 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out, color 0.1s ease-in-out;
            display: inline-block;
            position: relative;
        }
        span.spoiler::before {
            content: attr(data-title);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #dcddde;
            padding: 2px 6px;
            background-color: rgba(32, 34, 37, 0.8);
            border-radius: 3px;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        span.spoiler.small-title::before {
            font-size: 12px;
        }
        span.spoiler.large-title::before {
            font-size: 16px;
        }
        span.spoiler.revealed {
            background-color: transparent;
            color: inherit;
        }
        span.spoiler.revealed::before {
            opacity: 0;
        }
        span.spoiler:not(.revealed):hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* タスクリスト */
        .task-list-item {
            list-style-type: none;
            margin-left: -1.5em;
            position: relative;
            padding-left: 1.8em;
            min-height: 1.5em;
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5em;
        }
        .task-list-item input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 1.2em;
            height: 1.2em;
            border: 2px solid #72767d;
            border-radius: 4px;
            background-color: #40444b;
            cursor: default;
            margin-top: 0.15em;
            margin-right: 0.6em;
            flex-shrink: 0;
            position: relative;
            vertical-align: top;
            display: inline-block;
        }
        .task-list-item input[type="checkbox"]:checked {
            background-color: #5865f2;
            border-color: #5865f2;
        }
        .task-list-item input[type="checkbox"]:checked::before {
            content: '';
            display: block;
            width: 0.3em;
            height: 0.6em;
            border: solid #dcddde;
            border-width: 0 0.2em 0.2em 0;
            transform: rotate(45deg) translate(-50%, -60%);
            position: absolute;
            left: 50%;
            top: 50%;
        }
        .task-list-item input[type="checkbox"]:focus {
            outline: none;
            box-shadow: 0 0 0 0.2em rgba(88, 101, 242, 0.5);
        }
        .task-list-item input[type="checkbox"]:checked + span,
        .task-list-item input[type="checkbox"]:checked + label {
            color: #8e9297;
            text-decoration: line-through;
        }
        .task-list-item > span,
        .task-list-item > label {
            margin-top: 0.05em;
            line-height: 1.3;
            color: #dcddde;
        }

                /* === カスタムハイライト === */
        #preview mark.custom-highlight, mark.custom-highlight {
            background: rgba(255, 255, 80, 0.82);
            color: #181818;
            padding: 0.22em 0.45em;
            border-radius: 4px;
            font-weight: 600;
            box-shadow: 0 1px 4px #e6e60033;
            opacity: 0.99;
            line-height: 1.9;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s, opacity 0.2s;
        }
        #preview mark.custom-highlight:hover, mark.custom-highlight:hover {
            background: rgba(255, 255, 160, 0.98);
            color: #111;
            opacity: 1;
        }

        /* === diff コードブロック用 === */
        #preview pre code.language-diff .hljs-addition, pre code.language-diff .hljs-addition {
            display: block;
            background: linear-gradient(90deg, rgba(80, 220, 120, 0.32) 80%, rgba(80, 220, 120, 0.12) 100%);
            color: #2ecc40;
            font-weight: bold;
            border-left: 4px solid #2ecc40;
            padding-left: 0.5em;
        }
        #preview pre code.language-diff .hljs-deletion, pre code.language-diff .hljs-deletion {
            display: block;
            background: linear-gradient(90deg, rgba(255, 80, 80, 0.32) 80%, rgba(255, 80, 80, 0.12) 100%);
            color: #ff5555;
            font-weight: bold;
            border-left: 4px solid #ff5555;
            padding-left: 0.5em;
        }
    </style>
</head>
<body>
<!-- ...省略... -->

<script type="module">
import SimpleTextProcessor from './simple-text-processor.js';
// ...既存のコード...

// --- diff コードブロックのシンタックスハイライト ---
previewRenderer.code = function(code, infostring, escaped) {
    const lang = (infostring || '').match(/\S*/)[0];
    if (lang === 'ansi') {
        const converter = new AnsiToHtml();
        const html = converter.toHtml(code);
        return `<pre class="code-block"><code class="hljs language-ansi">${html}</code></pre>`;
    }
    const shouldRenderHtml = lang && lang.endsWith('!');
    const actualLang = lang ? lang.replace(/!$/, '') : '';
    if (shouldRenderHtml && actualLang === 'html') {
        const sanitizedHtml = DOMPurify.sanitize(code, { USE_PROFILES: { html: true } });
        return `<div class="rendered-html-block">${sanitizedHtml}</div>`;
    }
    let highlightedCode;
    if (actualLang === 'diff') {
        highlightedCode = code.split('\n').map(line => {
            if (/^\+/.test(line)) {
                return `<span class=\"hljs-addition\">${escapeHtml(line)}</span>`;
            } else if (/^-/.test(line)) {
                return `<span class=\"hljs-deletion\">${escapeHtml(line)}</span>`;
            } else {
                return escapeHtml(line);
            }
        }).join('\n');
    } else {
        highlightedCode = code.replace(/[&<>"']/g, function(tag) {
            const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
            return chars[tag] || tag;
        });
    }
    return `<pre class="code-block"><code class="hljs language-${actualLang}">${highlightedCode}</code></pre>`;
};

function escapeHtml(str) {
    return str.replace(/[&<>"']/g, function(tag) {
        const chars = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return chars[tag] || tag;
    });
}
</script>
    </style>
</head>
<body>
<h1>シンプルテキストツール</h1>

<div class="title-input">
    <input type="text" id="title-field" placeholder="タイトル (省略可能)">
</div>

<textarea id="input" placeholder="テキストをMarkdown形式で入力してください...
例:
# 見出し
- リスト項目
[リンク](http://example.com)"></textarea>

<div class="controls">
    <select id="user-select">
        <option value="0">-- 発言者を選択 --</option>
    </select>
    <select id="feel-select">
        <option value="0">-- 感情を選択 --</option>
    </select>
    <select id="action-select">
        <option value="0">-- 動作を選択 --</option>
    </select>
    <select id="ending-select">
        <option value="0">-- 末尾を選択 --</option>
    </select>
</div>

<div class="encoding-toggle">
    <label>
        <input type="radio" name="encoding" value="utf8" checked> 日本語そのまま (短いURL)
    </label>
    <label>
        <input type="radio" name="encoding" value="base64"> Base64エンコード (長いURL)
    </label>
    <span id="encoding-warning" style="color:#f04747;display:none;margin-left:10px;font-size:14px;"></span>
</div>

<div class="buttons">
    <button id="preview-btn">プレビュー</button>
    <button id="share-btn">共有URL生成</button>
</div>

<div style="margin: 10px 0;">
    <label>分割枚数: <input type="number" id="split-count" min="1" max="100" value="1" style="width:60px;"></label>
    <button id="split-generate-btn" class="button-secondary">分割リンク生成</button>
</div>
<div id="split-links"></div>

<!-- 画像生成/読込モード -->
<div style="margin: 18px 0; padding: 12px; background:#23272a; border-radius:6px;">
    <b>画像生成/読込モード</b><br>
    <button id="generate-image-btn" class="button-secondary">テキスト→画像(PNG)生成</button>
    <input type="file" id="image-upload" accept="image/png" style="display:inline-block; margin-left:10px;">
    <span id="image-status" style="margin-left:10px;color:#8e9297;"></span>
    <div id="image-preview" style="margin-top:10px;"></div>
</div>

<!-- バイパスリンク専用入力欄 -->
<div style="margin: 18px 0; padding: 12px; background:#23272a; border-radius:6px;">
    <b>バイパスリンク（共有URLテキスト/画像ダウンロード用）</b><br>
    <input type="text" id="bypass-link" placeholder=".txt/.pngダウンロードリンク" style="width:70%;">
    <button id="bypass-fetch-btn">バイパス取得</button>
    <span id="bypass-status" style="margin-left:10px;color:#8e9297;"></span>
</div>

<div id="preview">プレビューエリア</div>
<div id="url-length" class="url-length"></div>

<div class="format-guide">
    <h3>Markdown書式ガイド:</h3>
    <p><code># H1</code>, <code>## H2</code>, <code>### H3</code> など: 見出し</p>
    <p><code>- リスト</code>, <code>* リスト</code>, <code>+ リスト</code>: 箇条書きリスト (ネスト可)</p>
    <p><code>1. 番号付きリスト</code>: 番号付きリスト (ネスト可)</p>
    <p><code>&gt; 引用</code>: 引用</p>
    <p><code>```言語名\nコード\n```</code>: コードブロック (言語名は省略可)</p>
    <p><code>`インラインコード`</code>: インラインコード</p>
    <p><code>**太字**</code> または <code>__太字__</code>: 太字</p>
    <p><code>*イタリック*</code> または <code>_イタリック_</code>: イタリック</p>
    <p><code>~~打ち消し線~~</code>: 打ち消し線</p>
    <p><code>[リンクテキスト](URL)</code>: リンク</p>
    <p><code>![代替テキスト](画像URL)</code>: 画像</p>
    <p><code>| Th1 | Th2 |<br>|---|---|<br>| Td1 | Td2 |</code>: テーブル</p>
    <p><code>- [ ] 未完了タスク</code>, <code>- [x] 完了タスク</code>: タスクリスト</p>
    <p><code>---</code> または <code>***</code> または <code>___</code>: 水平線</p>
    <p><code>||スポイラーテキスト||</code>: スポイラー (独自拡張)</p>
    <p><code>🦋</code>: 蝶の絵文字はホバー・クリックでアニメーション</p>
    <p><code>-# この行</code>: 行頭に <code>-# </code> で小さく薄い文字</p>
    <p><code>:--\n複数行\n--:</code>: 複数行を小さく薄い文字</p>
    <p><code>::小さい文字::</code>: 行中の一部だけ小さく薄い文字</p>
    <p><em>(注意: 数式は現在サポートされていません)</em></p>
</div>

<script type="module">
    import SimpleTextProcessor from './simple-text-processor.js';

    // --- グローバル変数 ---
    const processor = new SimpleTextProcessor();
    let expressionsData = null;

    // --- marked の設定 ---
    const previewRenderer = new marked.Renderer();

    // タスクリスト
    previewRenderer.listitem = function(text, task, checked) {
        if (task) {
            const checkboxHtml = `<input type="checkbox" disabled ${checked ? 'checked' : ''}> `;
            const cleanedText = text.replace(/<label>|<\/label>/g, '');
            const itemClass = checked ? 'task-list-item task-list-item-checked' : 'task-list-item';
            return `<li class="${itemClass}">${checkboxHtml}<span>${cleanedText}</span></li>`;
        }
        return `<li>${text}</li>`;
    };

    marked.setOptions({
        renderer: previewRenderer,
        gfm: true,
        breaks: true,
        pedantic: false,
        smartLists: true,
        smartypants: false,
    });

    // スポイラー拡張
    const spoilerExtension = {
        name: 'spoiler',
        level: 'inline',
        start(src) { return src.match(/\|\|/)?.index; },
        tokenizer(src, tokens) {
            const rule = /^\|\|(\[([^\]]+)\])?([\s\S]+?)\|\|/;
            const match = rule.exec(src);
            if (match) {
                const title = match[2] || '';
                const textTokens = this.lexer.inlineTokens(match[3].trim());
                return { type: 'spoiler', raw: match[0], title, tokens: textTokens };
            }
        },
        renderer(token) {
            const titleAttr = token.title ? ` data-title="${token.title}"` : '';
            const isLargeTitle = token.raw.startsWith('||') && token.raw.endsWith(`[${token.title}]||`);
            const sizeClass = isLargeTitle ? 'large-title' : 'small-title';
            return `<span class="spoiler ${sizeClass}"${titleAttr}>${this.parser.parseInline(token.tokens)}</span>`;
        }
    };
    marked.use({ extensions: [spoilerExtension] });

    // ==ハイライト== 拡張
    const highlightExtension = {
        name: 'highlight',
        level: 'inline',
        start(src) { return src.indexOf('=='); },
        tokenizer(src) {
            const match = src.match(/^==([^=\n][\s\S]*?[^=\n])==/);
            if (match) {
                return {
                    type: 'highlight',
                    raw: match[0],
                    text: match[1],
                    tokens: this.lexer.inlineTokens(match[1])
                };
            }
        },
        renderer(token) {
            return `<mark class="custom-highlight">${this.parser.parseInline(token.tokens)}</mark>`;
        }
    };
    marked.use({ extensions: [highlightExtension] });

    // --- 追加: -# 行・:--～--:範囲・🦋拡張 ---
    const smallLineExtension = {
        name: 'smallLine',
        level: 'block',
        start(src) { return src.match(/(^|\n)(-# )|:--/)?.index; },
        tokenizer(src) {
            // :-- ～ --: の範囲
            if (src.startsWith(':--')) {
                const end = src.indexOf('--:');
                if (end !== -1) {
                    const content = src.slice(3, end).replace(/^\n+|\n+$/g, '');
                    return {
                        type: 'smallBlock',
                        raw: src.slice(0, end + 3),
                        text: content
                    };
                }
            }
            // -# 行
            const m = src.match(/^(?:-# )(.*)(?:\n|$)/);
            if (m) {
                return {
                    type: 'smallLine',
                    raw: m[0],
                    text: m[1]
                };
            }
        },
        renderer(token) {
            if (token.type === 'smallBlock') {
                return `<div class=\"small-muted\">${marked.parse(token.text)}</div>`;
            }
            if (token.type === 'smallLine') {
                return `<div class=\"small-muted\">${marked.parseInline(token.text)}</div>`;
            }
        }
    };
    // 🦋拡張: inlineで🦋をspan化
    const butterflyExtension = {
        name: 'butterfly',
        level: 'inline',
        start(src) { return src.indexOf('🦋'); },
        tokenizer(src) {
            if (src.startsWith('🦋')) {
                return {
                    type: 'butterfly',
                    raw: '🦋',
                };
            }
        },
        renderer() {
            return '<span class=\"interactive-butterfly\" tabindex=\"0\" role=\"button\">🦋</span>';
        }
    };
    marked.use({ extensions: [smallLineExtension, butterflyExtension] });

    // --- 初期化処理 ---
    async function init() {
        try {
            expressionsData = await processor.loadExpressions();
            processor.expressionsData = expressionsData;
            console.log("Expressions loaded successfully.");
        } catch (error) {
            console.error("Failed to load expressions:", error);
            expressionsData = {
                users: { '0': '未設定' }, feels: { '0': '未設定' },
                actions: { '0': '未設定' }, endings: { '0': '未設定', '1': '。' }
            };
            processor.expressionsData = expressionsData;
        }
        populateSelects();
        setupEventListeners();
        updatePreview();
        updateURLLengthComparison();
    }

    // --- ドロップダウンリスト設定 ---
    function populateSelects() {
        if (!expressionsData) return;
        const selects = {
            'user-select': expressionsData.users, 'feel-select': expressionsData.feels,
            'action-select': expressionsData.actions, 'ending-select': expressionsData.endings
        };
        Object.entries(selects).forEach(([id, options]) => {
            const select = document.getElementById(id);
            if (!select) return;
            select.innerHTML = '';
            if (typeof options !== 'object' || options === null) {
                options = { '0': '読込失敗' };
            }
            Object.entries(options).forEach(([value, text]) => {
                if (text !== 'none-date') {
                    const displayText = (value === '0') ? `-- ${id.replace('-select', '')}を選択 --` : text;
                    select.add(new Option(displayText, value));
                }
            });
            select.value = '0';
        });
    }

    // --- イベントリスナー設定 ---
    function setupEventListeners() {
        const input = document.getElementById('input');
        const titleField = document.getElementById('title-field');
        const previewBtn = document.getElementById('preview-btn');
        const shareBtn = document.getElementById('share-btn');
        const controls = document.querySelectorAll('select');
        const previewArea = document.getElementById('preview');
        const encodingRadios = document.querySelectorAll('input[name="encoding"]');

        const updateAll = () => { updatePreview(); updateURLLengthComparison(); };

        previewBtn.addEventListener('click', function() {
            // 現在の内容でview.htmlに遷移
            const input = document.getElementById('input');
            const titleValue = document.getElementById('title-field').value.trim();
            const text = input.value;
            const useBase64 = document.querySelector('input[name="encoding"]:checked').value === 'base64';
            const metadata = processor.createMetadata(
                document.getElementById('user-select').value,
                document.getElementById('feel-select').value,
                document.getElementById('action-select').value,
                document.getElementById('ending-select').value
            );
            if (!text.trim() && !titleValue.trim()) {
                alert('テキストまたはタイトルを入力してください。'); return;
            }
            processor.generateShareURL(text, metadata, useBase64, titleValue).then(({url}) => {
                window.open('view.html' + url, '_blank');
            }).catch(e => {
                alert('プレビュー用URL生成に失敗しました: ' + e.message);
            });
        });
        shareBtn.addEventListener('click', generateShareURL);
        input.addEventListener('input', updateAll);
        titleField.addEventListener('input', updateAll);
        controls.forEach(control => control.addEventListener('change', updateAll));
        encodingRadios.forEach(radio => radio.addEventListener('change', updateURLLengthComparison));

        // スポイラークリック処理
        previewArea.addEventListener('click', function(e) {
            const spoilerElement = e.target.closest('span.spoiler');
            if (spoilerElement) {
                spoilerElement.classList.toggle('revealed');
            }
        });
    }

    // --- プレビュー更新 ---
    function updatePreview() {
        const input = document.getElementById('input');
        const titleValue = document.getElementById('title-field').value.trim();
        const metadata = processor.createMetadata(
            document.getElementById('user-select').value,
            document.getElementById('feel-select').value,
            document.getElementById('action-select').value,
            document.getElementById('ending-select').value
        );
        const preview = document.getElementById('preview');

        // Markdown部分のコンテンツを作成
        let markdownContent = input.value;
        if (titleValue) {
            markdownContent = `# ${titleValue}\n\n${markdownContent}`;
        }

        // MarkdownをHTMLに変換
        let htmlContent = marked.parse(markdownContent);
        htmlContent = DOMPurify.sanitize(htmlContent);

        // メタデータ部分のテキストを生成
        const metadataSuffix = processor.formatPreview('', metadata, '');

        // プレビューエリアにHTMLを挿入
        if (metadataSuffix.trim()) {
            preview.innerHTML = htmlContent + `<div class="metadata-suffix">${metadataSuffix}</div>`;
        } else {
            preview.innerHTML = htmlContent;
        }

        // 🦋インタラクション付与
        setupButterflyInteractions(preview);
    }

    // --- URL長さ比較更新 ---
    function updateURLLengthComparison() {
        const input = document.getElementById('input');
        const titleValue = document.getElementById('title-field').value.trim();
        const text = input.value;
        const urlLengthDiv = document.getElementById('url-length');
        const encodingWarning = document.getElementById('encoding-warning');

        if (!text.trim() && !titleValue.trim()) {
            urlLengthDiv.textContent = '';
            encodingWarning.style.display = 'none';
            return;
        }

        const metadata = processor.createMetadata(
            document.getElementById('user-select').value,
            document.getElementById('feel-select').value,
            document.getElementById('action-select').value,
            document.getElementById('ending-select').value
        );

        try {
            const utf8Url = processor.createShareableURL(text, metadata, false, titleValue);
            const base64Url = processor.createShareableURL(text, metadata, true, titleValue);
            const utf8Length = utf8Url.length;
            const base64Length = base64Url.length;
            const diff = base64Length - utf8Length;
            const percent = utf8Length > 0 ? ((base64Length / utf8Length) * 100 - 100).toFixed(0) : 0;
            urlLengthDiv.textContent = `URL長さ比較: 通常 ${utf8Length}文字 vs Base64 ${base64Length}文字 (${diff >= 0 ? '+' : ''}${diff}文字, ${percent}% ${diff >= 0 ? '増' : '減'})`;

            // --- ここで警告表示ロジック ---
            const useBase64 = document.querySelector('input[name="encoding"]:checked').value === 'base64';
            // 通常エンコードかつ、スペース・改行・記号が含まれる場合は警告
            if (!useBase64 && /[\s"'`#%&?=<>\\\[\]{}|^~]/.test(text+titleValue)) {
                encodingWarning.textContent = '※ SNSやチャットでリンク切れ防止のため「Base64エンコード」推奨 (スペース・改行・記号が含まれています)';
                encodingWarning.style.display = '';
            } else {
                encodingWarning.style.display = 'none';
            }
        } catch (error) {
            console.error("Error calculating URL lengths:", error);
            urlLengthDiv.textContent = 'URL長さ: 計算エラー';
            encodingWarning.style.display = 'none';
        }
    }

    // --- 共有URL生成 ---
    async function generateShareURL() {
        const input = document.getElementById('input');
        const titleValue = document.getElementById('title-field').value.trim();
        const text = input.value;
        const useBase64 = document.querySelector('input[name="encoding"]:checked').value === 'base64';

        if (!text.trim() && !titleValue.trim()) {
            alert('テキストまたはタイトルを入力してください。'); return;
        }

        const metadata = processor.createMetadata(
            document.getElementById('user-select').value,
            document.getElementById('feel-select').value,
            document.getElementById('action-select').value,
            document.getElementById('ending-select').value
        );

        try {
            const { url, message } = await processor.generateShareURL(text, metadata, useBase64, titleValue);
            alert(message || '共有URLをクリップボードにコピーしました！');
        } catch (error) {
            console.error('共有URL生成エラー:', error);
            alert(`URLの生成またはコピーに失敗しました。\n${error.message}`);
        }
    }

    // --- 分割リンク生成 ---
    document.getElementById('split-generate-btn').addEventListener('click', async function() {
        const input = document.getElementById('input');
        const titleValue = document.getElementById('title-field').value.trim();
        const text = input.value;
        const splitCount = Math.max(1, Math.min(100, parseInt(document.getElementById('split-count').value, 10) || 1));
        const useBase64 = document.querySelector('input[name="encoding"]:checked').value === 'base64';
        const metadata = processor.createMetadata(
            document.getElementById('user-select').value,
            document.getElementById('feel-select').value,
            document.getElementById('action-select').value,
            document.getElementById('ending-select').value
        );
        const splitLinksDiv = document.getElementById('split-links');
        splitLinksDiv.innerHTML = '';
        if (!text.trim() && !titleValue.trim()) {
            splitLinksDiv.innerHTML = '<span style="color:#f04747">テキストまたはタイトルを入力してください。</span>';
            return;
        }
        // テキストを行ごとに分割
        const lines = text.split(/\r?\n/).filter(l=>l.length>0);
        const chunkSize = Math.ceil(lines.length / splitCount);
        let chunks = [];
        for (let i = 0; i < splitCount; i++) {
            const chunkLines = lines.slice(i*chunkSize, (i+1)*chunkSize);
            if (chunkLines.length > 0) {
                chunks.push(chunkLines.join('\n'));
            }
        }
        // 各分割ごとにURL生成
        let html = '';
        let showSplitWarning = false;
        for (let i = 0; i < chunks.length; i++) {
            try {
                const { url } = await processor.generateShareURL(chunks[i], metadata, useBase64, titleValue ? `${titleValue} (${i+1})` : `分割${i+1}`);
                const hasProblemChars = !useBase64 && /[\s"'`#%&?=<>\\\[\]{}|^~]/.test(chunks[i]+titleValue);
                if (hasProblemChars) showSplitWarning = true;
                html += `<div style="margin-bottom:8px;display:flex;align-items:center;gap:8px;">
                    <span style="font-weight:bold;min-width:2em;">${i+1}.</span>
                    <input type="text" value="${location.origin + location.pathname.replace(/index.html$/, 'view.html') + url}" readonly style="width:60%;font-size:14px;">
                    <button class="copy-link-btn" data-link="${location.origin + location.pathname.replace(/index.html$/, 'view.html') + url}">コピー</button>
                </div>`;
            } catch (e) {
                html += `<div style="color:#f04747">${i+1}. URL生成失敗: ${e.message}</div>`;
            }
        }
        splitLinksDiv.innerHTML = html;
        // コピーボタンイベント
        splitLinksDiv.querySelectorAll('.copy-link-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const link = btn.getAttribute('data-link');
                navigator.clipboard.writeText(link).then(() => {
                    btn.textContent = 'コピー済!';
                    setTimeout(()=>btn.textContent='コピー', 1200);
                });
            });
        });
        // 分割時も警告
        let splitWarn = document.getElementById('split-encoding-warning');
        if (!splitWarn) {
            splitWarn = document.createElement('div');
            splitWarn.id = 'split-encoding-warning';
            splitWarn.style.color = '#f04747';
            splitWarn.style.fontSize = '14px';
            splitWarn.style.margin = '8px 0';
            splitLinksDiv.parentNode.insertBefore(splitWarn, splitLinksDiv);
        }
        splitWarn.style.display = showSplitWarning ? '' : 'none';
        splitWarn.textContent = showSplitWarning ? '※ 分割リンクの一部にスペース・改行・記号が含まれています。SNSやチャットでリンク切れ防止のため「Base64エンコード」推奨' : '';
    });

    // --- 🦋バタフライインタラクション ---
    function setupButterflyInteractions(parentElement) {
        if (!parentElement) return;
        parentElement.querySelectorAll('.interactive-butterfly').forEach(span => {
            span.addEventListener('mouseover', e => span.classList.add('butterfly-hover'));
            span.addEventListener('mouseout', e => span.classList.remove('butterfly-hover'));
            span.addEventListener('click', e => flyButterfly(span));
            span.addEventListener('keydown', e => {
                if (e.key === 'Enter' || e.key === ' ') flyButterfly(span);
            });
        });
    }
    function flyButterfly(span) {
        if (span.dataset.isFlying === 'true') return;
        span.dataset.isFlying = 'true';
        const rect = span.getBoundingClientRect();
        // 蝶々の中心座標を取得
        const centerX = rect.left + window.scrollX + rect.width / 2;
        const centerY = rect.top + window.scrollY + rect.height / 2;
        const flying = document.createElement('span');
        flying.textContent = '🦋';
        flying.className = 'flying-butterfly';
        flying.style.left = `${centerX}px`;
        flying.style.top = `${centerY}px`;
        document.body.appendChild(flying);
        // パーティクル
        const particlesContainer = document.createElement('div');
        particlesContainer.className = 'butterfly-particle-container';
        document.body.appendChild(particlesContainer);
        // アニメーション
        const duration = 2200 + Math.random()*1200;
        const startX = centerX;
        const startY = centerY;
        const endX = startX + (Math.random()-0.5)*window.innerWidth*0.8;
        const endY = startY - (Math.random()*window.innerHeight*0.5 + window.innerHeight*0.3);
        const ctrlX1 = startX + (Math.random()-0.5)*300;
        const ctrlY1 = startY - Math.random()*120 - 40;
        const ctrlX2 = endX + (Math.random()-0.5)*200;
        const ctrlY2 = endY + Math.random()*80 + 30;
        let lastParticle = 0;
        let t = 0;
        function animate(ts) {
            t = t || ts;
            const progress = Math.min((ts-t)/duration, 1);
            // ベジェ曲線
            const u = 1-progress;
            const x = u*u*u*startX + 3*u*u*progress*ctrlX1 + 3*u*progress*progress*ctrlX2 + progress*progress*progress*endX;
            const y = u*u*u*startY + 3*u*u*progress*ctrlY1 + 3*u*progress*progress*ctrlY2 + progress*progress*progress*endY;
            flying.style.left = `${x}px`;
            flying.style.top = `${y}px`;
            flying.style.transform = `rotate(${Math.sin(progress*Math.PI*6)*18}deg) scale(${1+Math.sin(progress*Math.PI*3)*0.13})`;
            if (progress > 0.6) flying.style.opacity = String(1-(progress-0.6)/0.4);
            // パーティクル（中心から発生）
            if (ts-lastParticle > 40 && progress < 0.85) {
                createButterflyParticle(x, y, particlesContainer);
                lastParticle = ts;
            }
            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                flying.remove();
                setTimeout(()=>particlesContainer.remove(), 900);
                span.dataset.isFlying = '';
            }
        }
        requestAnimationFrame(animate);
    }
    function createButterflyParticle(x, y, container) {
        const p = document.createElement('div');
        p.className = 'butterfly-particle';
        p.style.left = `${x-3}px`;
        p.style.top = `${y-3}px`;
        container.appendChild(p);
        let life = 0, max = 18+Math.random()*10;
        const dx = (Math.random()-0.5)*1.7, dy = (Math.random()-0.7)*1.2;
        function anim() {
            life++;
            p.style.transform = `translate(${dx*life*1.2}px,${dy*life*1.2}px) scale(${1-life/max})`;
            p.style.opacity = String(1-life/max);
            if (life<max) requestAnimationFrame(anim); else p.remove();
        }
        requestAnimationFrame(anim);
    }

    // --- Discord等のtxtダウンロードリンク自動読込 ---
    document.getElementById('input').addEventListener('input', async function(e) {
        const val = e.target.value.trim();
        const urlMatch = val.match(/^https?:\/\/.+\.(txt)(\?.*)?$/i);
        if (urlMatch) {
            try {
                const resp = await fetch(val, {cache:'reload'});
                if (!resp.ok) throw new Error('ダウンロード失敗');
                const txt = await resp.text();
                e.target.value = txt;
                updatePreview();
                updateURLLengthComparison();
            } catch (err) {
                alert('テキストファイルの取得に失敗しました: '+err.message);
            }
        }
    });

    // --- 画像生成/読込モード ---
    document.getElementById('generate-image-btn').addEventListener('click', function() {
        const input = document.getElementById('input');
        const text = input.value;
        if (!text.trim()) { alert('テキストを入力してください'); return; }
        // テキスト→PNG画像生成
        const encoder = new TextEncoder();
        const textBytes = encoder.encode(text);
        // PNGヘッダ+IHDR+IDAT+IENDを自作し、tEXtチャンクにテキストを埋め込む
        // ここではcanvasを使い、tEXtチャンクを追加する
        const canvas = document.createElement('canvas');
        canvas.width = 32; canvas.height = 32;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#23272a'; ctx.fillRect(0,0,32,32);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 12px sans-serif'; ctx.fillText('TXT',4,20);
        canvas.toBlob(async blob => {
            // PNGバイナリ取得
            const arrayBuffer = await blob.arrayBuffer();
            const uint8 = new Uint8Array(arrayBuffer);
            // tEXtチャンク生成
            const keyword = 'URLTEXT';
            const tEXtData = new Uint8Array(keyword.length + 1 + textBytes.length);
            for(let i=0;i<keyword.length;i++) tEXtData[i]=keyword.charCodeAt(i);
            tEXtData[keyword.length]=0; // null区切り
            tEXtData.set(textBytes, keyword.length+1);
            // tEXtチャンク構築
            function crc32(buf) {
                let table = window._crcTable;
                if (!table) {
                    table = window._crcTable = [];
                    for (let n = 0; n < 256; n++) {
                        let c = n;
                        for (let k = 0; k < 8; k++) c = ((c & 1) ? (0xedb88320 ^ (c >>> 1)) : (c >>> 1));
                        table[n] = c;
                    }
                }
                let crc = -1;
                for (let i = 0; i < buf.length; i++) crc = (crc >>> 8) ^ table[(crc ^ buf[i]) & 0xff];
                return (crc ^ -1) >>> 0;
            }
            function insertTextChunk(png) {
                // PNG signature: 8 bytes
                // After IHDR (first chunk), insert tEXt
                let pos = 8;
                // Find end of IHDR
                while (pos < png.length) {
                    const len = (png[pos]<<24)|(png[pos+1]<<16)|(png[pos+2]<<8)|png[pos+3];
                    const type = String.fromCharCode(...png.slice(pos+4,pos+8));
                    if (type==='IHDR') { pos += 8+len+4; break; }
                    pos += 8+len+4;
                }
                // tEXtチャンク作成
                const chunkType = [0x74,0x45,0x58,0x74]; // 'tEXt'
                const chunkLen = tEXtData.length;
                const chunk = new Uint8Array(4+chunkType.length+chunkLen+4);
                chunk[0]=(chunkLen>>>24)&0xff; chunk[1]=(chunkLen>>>16)&0xff; chunk[2]=(chunkLen>>>8)&0xff; chunk[3]=chunkLen&0xff;
                chunk.set(chunkType,4);
                chunk.set(tEXtData,8);
                const crc = crc32(new Uint8Array([...chunkType,...tEXtData]));
                chunk.set([(crc>>>24)&0xff,(crc>>>16)&0xff,(crc>>>8)&0xff,crc&0xff],8+chunkLen);
                // 新しいPNG
                const newPng = new Uint8Array(png.length+chunk.length);
                newPng.set(png.slice(0,pos),0);
                newPng.set(chunk,pos);
                newPng.set(png.slice(pos),pos+chunk.length);
                return newPng;
            }
            const pngWithText = insertTextChunk(uint8);
            const blob2 = new Blob([pngWithText],{type:'image/png'});
            const url = URL.createObjectURL(blob2);
            const a = document.createElement('a');
            a.href = url; a.download = 'text.png';
            a.textContent = '画像をダウンロード';
            a.style.display = 'inline-block';
            const img = document.createElement('img');
            img.src = url; img.style.maxWidth='120px'; img.style.marginLeft='10px';
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '';
            preview.appendChild(a);
            preview.appendChild(img);
            document.getElementById('image-status').textContent = '画像にテキストを埋め込みました';
        },'image/png');
    });
    // 画像アップロード→テキスト抽出
    document.getElementById('image-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            const arr = new Uint8Array(ev.target.result);
            // tEXtチャンク探索
            let pos = 8;
            let found = false;
            while (pos < arr.length) {
                const len = (arr[pos]<<24)|(arr[pos+1]<<16)|(arr[pos+2]<<8)|arr[pos+3];
                const type = String.fromCharCode(...arr.slice(pos+4,pos+8));
                if (type==='tEXt') {
                    // keyword\0text
                    let i=8;
                    while(i<8+len && arr[pos+i]!==0) i++;
                    const keyword = String.fromCharCode(...arr.slice(pos+8,pos+i));
                    if (keyword==='URLTEXT') {
                        const textBytes = arr.slice(pos+i+1,pos+8+len);
                        const decoder = new TextDecoder();
                        const text = decoder.decode(textBytes);
                        document.getElementById('input').value = text;
                        updatePreview();
                        updateURLLengthComparison();
                        document.getElementById('image-status').textContent = '画像からテキストを抽出しました';
                        found = true; break;
                    }
                }
                pos += 8+len+4;
            }
            if (!found) {
                document.getElementById('image-status').textContent = 'テキスト埋め込みPNGではありません';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // --- バイパスリンク専用処理 ---
    document.getElementById('bypass-fetch-btn').addEventListener('click', handleBypassLink);
    document.getElementById('bypass-link').addEventListener('paste', function(e){ setTimeout(handleBypassLink, 50); });
    async function handleBypassLink() {
        const url = document.getElementById('bypass-link').value.trim();
        const status = document.getElementById('bypass-status');
        if (!isDownloadLinkByExt(url, '.txt') && !isDownloadLinkByExt(url, '.png')) {
            status.textContent = '有効な.txt/.pngダウンロードURLを入力してください';
            return;
        }
        // バイパス取得時はフォーム内容をクリア
        document.getElementById('input').value = '';
        document.getElementById('title-field').value = '';
        // 他入力を一時的に無効化
        document.getElementById('input').disabled = true;
        document.getElementById('title-field').disabled = true;
        document.getElementById('user-select').disabled = true;
        document.getElementById('feel-select').disabled = true;
        document.getElementById('action-select').disabled = true;
        document.getElementById('ending-select').disabled = true;
        status.textContent = 'バイパスリンクを経由中...';
        try {
            let shareUrl = null;
            if (isDownloadLinkByExt(url, '.txt')) {
                try {
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error('ダウンロード失敗');
                    const txt = await resp.text();
                    shareUrl = processor.extractShareableUrlFromText(txt);
                } catch (err) {
                    status.textContent = 'CORS制限のため.txtファイルを取得できません。ファイルを一度ダウンロードし、テキスト欄に貼り付けてください。';
                    return;
                }
            } else if (isDownloadLinkByExt(url, '.png')) {
                try {
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error('ダウンロード失敗');
                    const arrayBuffer = await resp.arrayBuffer();
                    const text = extractTextFromPng(new Uint8Array(arrayBuffer));
                    if (!text) throw new Error('画像にテキストが埋め込まれていません');
                    shareUrl = processor.extractShareableUrlFromText(text);
                } catch (err) {
                    // 画像はCORS制限でも<img>で表示可能
                    const preview = document.getElementById('image-preview');
                    preview.innerHTML = `<img src="${url}" style="max-width:220px;display:block;margin:10px 0;">` +
                      `<div style="color:#f04747">CORS制限のため画像からテキスト抽出はできません。画像を一度ダウンロードし、アップロードしてください。</div>`;
                    status.textContent = 'CORS制限のため画像からテキスト抽出不可';
                    return;
                }
            }
            if (!shareUrl) throw new Error('共有URLが見つかりません');
            // 共有URLをフォームに反映
            const parsed = processor.parseShareableURL(shareUrl.startsWith('#') ? shareUrl : ('#'+shareUrl.split('#')[1]));
            if (!parsed) throw new Error('URL解釈失敗');
            document.getElementById('input').value = parsed.text || '';
            document.getElementById('title-field').value = parsed.title || '';
            // メタデータも反映
            document.getElementById('user-select').value = processor.expressionsData && parsed.metadata.user ? Object.keys(processor.expressionsData.users).find(k=>processor.expressionsData.users[k]===parsed.metadata.user)||'0' : '0';
            document.getElementById('feel-select').value = processor.expressionsData && parsed.metadata.feel ? Object.keys(processor.expressionsData.feels).find(k=>processor.expressionsData.feels[k]===parsed.metadata.feel)||'0' : '0';
            document.getElementById('action-select').value = processor.expressionsData && parsed.metadata.action ? Object.keys(processor.expressionsData.actions).find(k=>processor.expressionsData.actions[k]===parsed.metadata.action)||'0' : '0';
            document.getElementById('ending-select').value = processor.expressionsData && parsed.metadata.ending ? Object.keys(processor.expressionsData.endings).find(k=>processor.expressionsData.endings[k]===parsed.metadata.ending)||'0' : '0';
            status.textContent = '取得成功';
            updatePreview();
            updateURLLengthComparison();
        } catch (err) {
            status.textContent = '取得失敗: ' + err.message;
        } finally {
            document.getElementById('input').disabled = false;
            document.getElementById('title-field').disabled = false;
            document.getElementById('user-select').disabled = false;
            document.getElementById('feel-select').disabled = false;
            document.getElementById('action-select').disabled = false;
            document.getElementById('ending-select').disabled = false;
        }
    }
    // --- バイパスリンク拡張子判定用: パス部分のみで判定 ---
    function isDownloadLinkByExt(url, ext) {
        try {
            const u = new URL(url);
            return u.pathname.toLowerCase().endsWith(ext);
        } catch {
            return false;
        }
    }
    // --- バイパス欄が空でない場合は共有リンク生成・プレビューを無効化 ---
    function isBypassActive() {
        return document.getElementById('bypass-link').value.trim().length > 0;
    }
    // 共有リンク生成・プレビュー時にガード
    ['preview-btn','share-btn'].forEach(id => {
        document.getElementById(id).addEventListener('click', function(e) {
            if (isBypassActive()) {
                alert('バイパスリンクが入力されている場合は、フォーム内容での共有リンク生成・プレビューはできません。\nバイパス欄を空にしてください。');
                e.preventDefault();
                return false;
            }
        }, true);
    });

    // --- 初期化実行 ---
    init();
</script>
</body>
</html>
